/*! BUILD: 2014-10-31 */
Common.controllers.SubMenu=Spine.Controller.sub({el:"#subMenu",init:function(){Spine.bind("showSubmenu",this.proxy(this.render)),$("#showMenu").on("click",this.proxy(this.showMenu)),$("#hideMenu").on("click",this.proxy(this.hideMenu))},events:{"click dt a":"clickSpan","click dt a span":"showContent","click dd a":"showContent"},render:function(a){var b=this,c=Common.menu.MenuHash[a],d=$("<div/>");b.el.children("dl,h3").remove(),isArray(c)&&c.length>0?(Spine.trigger("hideWelcome"),$("#full-container").hide(),b.el.show(),$("#showMenu").hide(),$("#main,#hideMenu").show(),$(c).each(function(a,b){var c,e,f,g,h;c=$("<dl></dl>"),e=$("<dt></dt>"),f=$('<a class="clearfix" href="javascript:void(0);"></a>'),0===a&&f.addClass("current"),f.append("<em></em>"),g=$("<span></span>"),g.attr("lan",b.lan),b.controller&&""!==b.controller&&g.attr("controller",b.controller),b.flow&&""!==b.flow&&g.attr("flow",b.flow),f.append(g),b.get_count&&(f.append($("<i></i>").attr("id",b.controller+"_count").addClass("red-circle").hide()),Common.postRequest(new Model("PSNCreatConversation")).then(function(a){var c=CU.ajaxDataHandle(a);Common.postRequest(new Model(b.get_count.model,b.get_count.params,c)).then(function(a){if(CU.isSuccesful(a)){var c=CU.ajaxDataHandle(a),d={PsnOcrmProductQuery:"recordNumber"};(c.length>0||c&&c.list&&c.list.length>0||c&&c.List&&c.List.length>0||c&&c.resultList&&c.resultList.length>0)&&(b.get_count.model in d&&(c=c[d[b.get_count.model]]),$("#"+b.controller+"_count").show().text(c))}})})),e.append(f),c.append(e),h=b.submenu,Common.triggerSubMenuAuto&&(0===a&&b.controller&&Spine.trigger("showContent",b.controller),0===a&&b.flow&&Spine.trigger("showContent",b.flow)),isArray(h)&&h.length>0?$(h).each(function(b,d){var e=$("<dd></dd>"),f=$("<a></a>").attr({href:"javascript:void(0);",lan:d.lan});0===a&&(e.css("display","block"),0===b&&(f.addClass("current"),d.controller&&Common.triggerSubMenuAuto&&Spine.trigger("showContent",d.controller))),d.controller&&f.attr("controller",d.controller),e.append(f),c.append(e)}):f.addClass("nosub"),c.appendTo(d)}),b.el.prepend(d.html())):(b.el.hide(),$("#main,#showMenu,#hideMenu").hide(),"WelcomePage"===a?($("#full-container").hide(),Spine.trigger("showWelcome")):(Spine.trigger("hideWelcome"),$("#full-container").show(),Spine.trigger("showContent",c,!0))),b.el.prepend("<h3 lan='"+$("#nav a[key="+a+"]").attr("lan")+"'>"+CU.getDictNameByKey($("#nav a[key="+a+"]").attr("lan"))+"</h3>"),CU.changeLan(b.el)},showContent:function(a){var b,c,d=this,e=$(a.target),f=a.target.nodeName,g=e.attr("controller"),h=e.attr("flow"),i=!0;if(a.preventDefault(),"SPAN"===f.toUpperCase()){c=e.closest("dt"),b=c.parent().children("dd"),e.parent().hasClass("current")?e.parent().hasClass("subclose")?(e.parent().removeClass("subclose"),b.css("display","block")):(e.parent().addClass("subclose"),b.length>0&&b.css("display","none")):(d.el.find("dl>dt>a").removeClass("current").removeClass("subclose"),e.parent().addClass("current"),d.el.find("dl>dd").css("display","none"),b.length>0&&b.eq(0)&&(b.css("display","block"),g&&(i=0===b.find("a.current").size()?b.eq(0).children("a"):!1)));try{e.closest("dl").children("dd").eq(0).children("a").trigger("click")}catch(a){}}else{if("A"!==f.toUpperCase())throw new Error("未知菜单: "+f);d.el.find("dl>dd>a").removeClass("current"),e.addClass("current")}g&&i&&(Spine.trigger("showContent",g),"boolean"!=typeof i&&i.trigger("click")),h&&Spine.trigger("showContent",h)},clickSpan:function(a){$(a.target).children("span").trigger("click")},showMenu:function(){this.el.show(),$("#showMenu").hide(),$("#hideMenu").show(),$("#content").removeClass("w978"),$(".btn_more_87495_div").is(":visible")&&this.resetMoreBar()},hideMenu:function(){this.el.hide(),$("#showMenu").show(),$("#hideMenu").hide(),$("#content").addClass("w978"),$(".btn_more_87495_div").is(":visible")&&this.resetMoreBar()},resetMoreBar:function(){var a=$(".btn_more_87495_div").filter(":visible");if(a.size()>0){var b;a.each(function(){$(this).hasClass("hide")||(b=this)});var c,d,e=$(b).attr("id"),f=e.substring(e.lastIndexOf("_")+1),g=$("#"+e).width(),h=$(".btn_more_87495[accountId="+f+"]");document.documentElement&&document.documentElement.scrollTop?(c=document.documentElement.scrollTop,d=document.documentElement.scrollLeft):document.body&&(c=document.body.scrollTop,d=document.body.scrollLeft);var i=$(h).position().left-g-d+60,j=$(h).position().top+$(h).height()+c+5;a.css({left:i+"px",top:j+"px",position:"absolute"})}}});