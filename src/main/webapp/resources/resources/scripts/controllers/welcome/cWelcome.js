/*! BUILD: 2015-05-19 */
Common.controllers.Welcome=Spine.Controller.sub({el:"#welcome",events:{"click #welcome-query":"query","click #serviceRecord-close":"closeServiceRecord","click #hyperchannel>a":"linkHandler","click .msgDetail":"showMsgDetail"},ejsPath:{sjviptsy:"templates/welcome/sjviptsy.ejs",sjviptscgy:"templates/welcome/sjviptscgy.ejs",msgDetail:"templates/welcome/msgdetail.ejs"},init:function(a){var b=this;b.callback=a,Spine.bind("showWelcome",this.proxy(this.show)),Spine.bind("hideWelcome",this.proxy(this.hide)),b.welcome(),$("#a_60_1169,#a_60_1170").on("click",function(a){a.preventDefault();var b=Common.currentUser,c=$("#pageNo em").text(),d=$(this).attr("href"),e={},f="loginName="+b.loginName+"&customerName="+b.customerName+"&mobile="+b.mobile+"&pageNo="+c+"&ErrorCode="+Common.Error.lastErrorCode;e.unEncryptData=f,Common.postRequest(new Model("PsnTransferDataEncrypt",e)).then(function(a){var b=CU.ajaxDataHandle(a);if(b){var c="encryptData="+b.encryptData,e=d+"?"+c,f=window.open(e,null,"toolbar=no, menubar=no,scrollbars=yes, location=no, status=no,resizable=yes,width=810,height=645");f.moveTo(Math.floor((screen.width-810)/2),Math.floor((screen.height-645)/2))}})}),$("#a_57_1166").on("click",function(){return $.browser.msie&&$.browser.version<=6?(Common.LightBox.showMessage(CU.getDictNameByKey("l14904")),!1):(Common.LightBox.show(),void Common.postRequest(new Model("SwitchLoginPortalGetTicket",{fromTerminalFlag:"WEB15",toTerminalFlag:"WEB20"},null)).then(function(a){if(a=CU.ajaxDataHandle(a)){var b=a.targetUrl+(/^.*\?$/.test(a.targetUrl)?"":"?")+"loginName="+a.loginName+"&fromTerminalFlag="+a.fromTerminalFlag+"&toTerminalFlag="+a.toTerminalFlag+"&ticketInfo="+a.ticketInfo+"&lan="+lan;try{$.ajax({url:"config/menu15To20.json"}).then(function(){return function(a){window.location.href=b+"&action="+a[Common.currentActionType]}}())}catch(c){window.location.href=b}}else Common.LightBox.hide()}))})},welcome:function(){var a=this;Common.postRequest(new Model("PsnCommonQueryOprLoginInfo")).then(function(b){Common.currentUser=CU.ajaxDataHandle(b),a.callback(),10==Common.currentUser.segmentId&&$(document.body).addClass("query-box"),1==Common.currentUser.segmentId&&a.checkIsOpenUpgrade(),Common.postRequest(new Model("PsnCommonGetWelcomePageData")).then(function(b){var c=CU.ajaxDataHandle(b);a.render(c),CU.isSuccesful(b)&&(1==c._TOKEN_EXPIRE_||2==c._TOKEN_EXPIRE_)&&(512==c.loginStatus||768==c.loginStatus?($("#eMsgExpiredDays").text(c.certExpire),$("#eMsgExpired").show()):($("#eMsgWarnDays").text(c._TOKEN_EXPIRE_DAY_),$("#eMsgWarn").show())),window.triggerAction&&Common.triggerAction(window.triggerAction)}),Common.LightBox.show(),Common.postRequest(new Model("PsnCommonQueryAllChinaBankAccount",{accountType:["103","104","107"]})).then(function(a){Common.LightBox.hide();var b=CU.ajaxDataHandle(a);b&&b.length<=0&&($("#welcome_userNoCreditCard").show(),$("#welcome_linkAccount").off("click").on("click",function(){Common.triggerAction("AccountAutoRelate")}),$("#welcome_crcdApplyOnline").off("click").on("click",function(){Common.triggerAction("CreditCardApplyOnline")}))}),Common.LightBox.show(),Common.postRequest(new Model("PsnCommonQueryOprIp")).then(function(a){Common.LightBox.hide(),ProxyCollector.externalIP=CU.ajaxDataHandle(a),ProxyCollector.initProxyCollection()}),a.el.show(),$("#footer").show(),$("#header .hide-for-init").show()})},render:function(a){if($("#main,#showMenu,#hideMenu").hide(),Common.postRequest(new Model("PsnWMSQueryWealthRank")).then(function(a){if(CU.isSuccesful(a)){var b=CU.ajaxDataHandle(a);b?($("#message-vip-type").attr("lan","CustLevel_"+b).text(CU.getDictNameByKey("CustLevel_"+b)),$(".message-vip").show()):$(".message-normal").show()}else $(".message-normal").show();$(".welcome-customerId").text(Common.currentUser.customerId),$("#welcome-customerName").text(Common.currentUser.customerName),$("#welcome-loginDate").text(Common.currentUser.lastLogin),$("#welcome-loginErrorDate").text(Common.currentUser.loginErrorDate),Common.currentUser.loginHint?($(".welcome-loginHint").text(Common.currentUser.loginHint),$(".welcome-loginHintPrefix").show()):$(".welcome-loginHint").attr("lan","l14856").text(CU.getDictNameByKey("l14856")),$("div.message").show()}),this.SvrRecType=new ITSelect({data:Common.ItSelectData.SvrRecType,appendTo:$("#welcome-SvrRecType"),defText:Common.ItSelectData.pleaseSelect,defVal:"",oddCls:"even"}),this.SvrRecType.setValue("01"),Common.LightBox.show(),DateUtil.getCurrentTime(function(b){Common.LightBox.hide(),$("#welcome-startDate").val(CU.Date.addDays(b.date,-6)).datepicker(),$("#welcome-startDate").attr("readonly","readonly"),$("#welcome-endDate").val(b.date).datepicker(),$("#welcome-endDate").attr("readonly","readonly");Common.currentUser.lastModify;512==a.loginStatus||768==a.loginStatus?($("#isModifyPWD").show(),$("#welcome_modifyPassword").on("click",function(){Common.triggerAction("PasswordSeting")})):$("#isModifyPWD").hide()}),Common.LightBox.show(),Common.postRequest(new Model("psnSvrGlobalMsgList")).then(function(a){Common.LightBox.hide();var b,c,d,e=CU.ajaxDataHandle(a);if("01"===a.response[0].status)for(d=e.length,d>3&&(d=3),b=0;d>b;b++)c=e[b],$("#latest-container").append($("<dd><a class='msgDetail' href=\"javascript:void(0);\" GblMsgId="+c.globalMsgId+">"+c.subject+"</a></dd>"))}),66==Common.currentUser.segmentId){try{initComponentHtml(1,"financial-container")}catch(b){}$("#news-link span.fl").each(function(a){$(this).on("click",function(){$("#news-wrap .news-container").hide().eq(a).show(),$("#news-link span.fl").removeClass("current"),$(this).addClass("current"),$("#news-link .morelink")[0===a?"show":"hide"]()})})}10==Common.currentUser.segmentId&&($("#subtitle").attr("lan","l15223").text(CU.getDictNameByKey("l15223")),$("#welcome_userNoCreditCard").html('<span lan="l15542" v="尊敬的客户，您尚未关联信用卡，建议您前往中行网点关联已有信用卡或开通理财版网银，如需申请新卡可通过。"></span><a href="javascript:void(0);" id="welcome_crcdApplyOnline" lan="l0302" v="在线申请信用卡" class="ml5"></a>'),CU.changeLan($("#welcome_userNoCreditCard"))),this.el.show(),Common.LightBox.hide()},query:function(){var a=this;if(formValid.checkAll("#welcome-query-form")){var b=$("#welcome-startDate").val(),c=$("#welcome-endDate").val();if(b>c)return void Common.LightBox.showMessage(CU.getDictNameByKey("l6882")+" "+CU.getDictNameByKey("l6883"));if(!CU.Date.inThreeMonth(b,c))return void Common.LightBox.showMessage(CU.getDictNameByKey("l7144"));var d=a.SvrRecType.val;if("SvrRecType_01"==d)a._query_zylcys();else if("SvrRecType_02"==d||"SvrRecType_a03"==d){var e="SvrRecType_02"==d?"00":"04";a._query_zyysyzf(e)}else a.queryData=new Model("PsnServiceLogQuery4Sme",{SvrRecType:a.SvrRecType.val,startDate:b,endDate:c}),Common.postRequest(a.queryData.findPage(1,10,!0)).then(function(b){var c=CU.ajaxDataHandle(b);c&&c.resultList&&c.resultList.length>0?a.el.append("templates/welcome/serviceRecord.ejs",function(){$("#idServiceQueryResultData").html("").html("templates/welcome/serviceRecordData.ejs",{resultList:c.resultList},function(){a.paging("templates/welcome/serviceRecordData.ejs",a.queryData,"#idServiceQueryResultData","#idServiceQueryResultPage",c.recordNumber,1),CU.changeLan(a.el),Common.LightBox.show(),$("#serviceRecord-popup").show(),CU.setObjAbsCenter($("#serviceRecord-popup"));var b=$("#idServiceQueryResultData").find(".tb-con");b.children().height()>250&&b.css("overflowY","scroll")})}):Common.LightBox.showMessage(CU.getDictNameByKey("l6014"))})}},paging:function(a,b,c,d,e,f){var g=this,h={canvas:d,callbackFn:function(f){Common.postRequest(b.findPage(f)).then(function(h){var i=CU.ajaxDataHandle(h);i?g.el.find(c).html(a,{resultList:i.resultList},function(){g.paging(a,b,c,d,e,f);var h=$("#idServiceQueryResultData").find(".tb-con");h.children().height()>250&&h.css("overflowY","scroll"),CU.changeLan(g.el.find(c))}):(g.el.find(d).empty(),g.el.find(d).hide())})},pageIndex:f,point:g,recordCount:e,pageSize:10,showDownload:!0,downClick:function(){var a=urlPrefix+"PsnServiceLogDownload4Sme.do?SvrRecType="+g.SvrRecType.val+"&startDate="+b.attributes.params.startDate+"&endDate="+b.attributes.params.endDate;$("#idServiceQueryResultPage #download").attr("target","_blank").attr("href",a)}},i=Pager.getInstance();i.init(h),$(d).show()},closeServiceRecord:function(){$("#serviceRecord-popup").remove(),Common.LightBox.hide()},linkHandler:function(a){var b=$(a.target),c=b.attr("key"),d=b.attr("controller");c&&$("#nav a[key="+c+"]").trigger("click"),d&&Common.triggerAction(d)},show:function(){this.el.show()},hide:function(){this.el.hide()},checkIsOpenUpgrade:function(){var a=this;Common.postRequest(new Model("CheckIsOpenUpgrade")).then(function(b){var c=CU.ajaxDataHandle(b);c&&"true"==c.upgradeFlag&&(Common.LightBox.show(),a.el.append(a.ejsPath.sjviptsy,{},function(){var b=a.el.find("#div_vip_tips");CU.changeLan(b),b.show(),Common.LightBox.show(),CU.setObjAbsCenter(b),Common.postRequest(CU.createConversation()).then(function(c){var d=CU.ajaxDataHandle(c);d&&Common.postRequest(CU.createTokenId(d)).then(function(c){var e=CU.ajaxDataHandle(c);e&&(a.el.find("a.close,#btn_cancel_106826").on("click",function(){var a={IsUpgrade:"0",ViewStatus:1==$("#cb_7944_106824_1").attr("checked")?"0":"1",token:e};Common.postRequest(new Model("UpgradeCustomRankResult",a,d)).then(function(a){CU.ajaxDataHandle(a),CU.closeConversation(d),b.remove(),Common.LightBox.hide()})}),a.el.find("#btn_sure_106825").on("click",function(){var a={IsUpgrade:"1",ViewStatus:1==$("#cb_7944_106824_1").attr("checked")?"0":"1",token:e};Common.postRequest(new Model("UpgradeCustomRankResult",a,d)).then(function(a){var c=CU.ajaxDataHandle(a);if(c){b.remove(),Common.LightBox.hide();var f="loginfromglb.html?loginName="+c.loginName+"&ticketInfo="+c.ticket+"&fromTerminalFlag=WEB15&toTerminalFlag=WEB15&lan="+lan;window.location=f}else Common.postRequest(CU.createTokenId(d)).then(function(a){e=CU.ajaxDataHandle(a)})})}))})})}))})},showMsgDetail:function(a){var b=this,c=$(a);Common.postRequest(new Model("psnSvrGlobalMsgDetail",{globalMsgId:c.attr("gblmsgid")})).then(function(a){var c=CU.ajaxDataHandle(a);c&&b.el.append(b.ejsPath.msgDetail,c,function(){var a=b.el.find("#pop_msg_detail").css({position:"absolute",zIndex:911}),d=c.content.replace(/\r\n/g,"<br/>");d=d.replace(/ /g,"&nbsp;"),a.find("#txt_postscript_25410").html(d),Common.LightBox.show(),CU.setObjAbsCenter(CU.changeLan(a)),a.on("click","a.close",function(){a.remove(),Common.LightBox.hide()})})})},_query_zylcys:function(){var a=this;a.bocEshopRecordsTable=new Common.Hashtable,a.queryData2=new Model("PsnEshopQueryNewOrder",{currentIndex:1,pageSize:10}),Common.LightBox.show(),Common.postRequest(a.queryData2.findPage(1,10,!0)).then(function(b){Common.LightBox.hide();var c=CU.ajaxDataHandle(b),d={signFlag:"1"};c&&c.orderList&&c.orderList.length>0?($.each(c.orderList,function(b,d){a.bocEshopRecordsTable.add(d.orderId,d),c.orderList[b].orderDate=c.orderList[b].orderDate.replace(/-/g,"/")}),a.el.append("templates/welcome/serviceRecord.ejs",function(){$("#idServiceQueryResultData").html("").html("templates/welcome/serviceRecordData2.ejs",{list:c.orderList,params:d},function(){a.bocPaging("templates/welcome/serviceRecordData2.ejs",a.queryData2,"#idServiceQueryResultData","#idServiceQueryResultPage",c.orderCount,1,d),CU.changeLan(a.el),Common.LightBox.show(),$("#serviceRecord-popup").show(),CU.setObjAbsCenter($("#serviceRecord-popup"));var b=$("#idServiceQueryResultData").find(".tb-con");b.children().height()>250&&b.css("overflowY","scroll"),a.el.find(".cancel_order").on("click",function(){a._cancel(this)}),a.el.find(".continue_order").on("click",function(){a._continueBuy(this),a.closeServiceRecord()})})})):Common.LightBox.showMessage(CU.getDictNameByKey("l6014"))})},_cancel:function(a){var b=this;Common.LightBox.show(),b.el.find("#serviceRecord-popup").css({"z-index":"5"}),b.el.append("templates/welcome/recordCancel.ejs",{},function(){var c=b.el.find("#OverviewOtherBankAcc_setNickName");CU.changeLan(c),CU.setObjAbsCenter(c),$("#btn_cancel_45983,a.close").on("click",function(){c.remove(),Common.LightBox.hide(),b.el.find("#serviceRecord-popup").css({"z-index":"911"})}),$("#btn_ok_45983").on("click",function(){b._orderCancel(a)})})},_continueBuy:function(a){var b=this;orderQuery=b.bocEshopRecordsTable.item($(a).attr("orderId"));var c="?amount="+orderQuery.amount+"&orderStatus="+orderQuery.orderStatus+"&quantity="+orderQuery.quantity+"&optType="+orderQuery.optType+"&productName="+orderQuery.productName+"&productId="+orderQuery.productId+"&orderDate="+orderQuery.orderDate+"&userCode="+orderQuery.userCode+"&productType="+orderQuery.productType+"&orderId="+orderQuery.orderId,d="C"==lan?"zh_CN":"en_US";c+="&locale="+d,window.location.href="/eshop/welcome.html"+c},_orderCancel:function(a){var b=this;Common.postRequest(CU.createConversation()).then(function(c){b.conversationId=CU.ajaxDataHandle(c),Common.postRequest(CU.createTokenId(b.conversationId)).then(function(c){b.tokenId=CU.ajaxDataHandle(c);var d={orderId:$(a).attr("orderId"),token:b.tokenId};Common.postRequest(new Model("PsnEshopCancelOrder",d,b.conversationId)).then(function(a){if(CU.isSuccesful(a)){b.closeServiceRecord();var c=b.el.find("#OverviewOtherBankAcc_setNickName");c.remove(),Common.LightBox.hide(),b._query_zylcys(),CU.closeConversation(b.conversationId)}else Common.postRequest(CU.createTokenId(b.conversationId)).then(function(a){b.tokenId=CU.ajaxDataHandle(a)})})})})},bocPaging:function(a,b,c,d,e,f,g,h){var i=this,j={canvas:d,callbackFn:function(e){Common.LightBox.show(),b.attributes.params._refresh="false",Common.postRequest(b.findPage(e)).then(function(f){var j=CU.ajaxDataHandle(f);if(i.bocEshopRecordsTable.clear(),$.each(j.orderList,function(a,b){i.bocEshopRecordsTable.add(b.orderId,b)}),"00"==h&&j&&j.orderList){var k=[];$.each(j.orderList,function(a,b){"04"!=b.orderStatus&&(k[k.length]=b)})}Common.LightBox.hide();var l=h?{list:j.orderList,params:g,orderSt:h}:{list:j.orderList,params:g};j&&j.orderList&&j.orderList.length>0&&(void 0==h||"04"==h?!0:k&&k.length)?i.el.find(c).html(a,l,function(){"SvrRecType_01"==i.SvrRecType.val&&(i.el.find("[id=a_cancel_52228]").on("click",function(){i._cancel(this)}),i.el.find("[id=a_continue_52227]").on("click",function(){i._continueBuy(this)})),i.bocPaging(a,b,c,d,j.orderCount,e,g),CU.changeLan(i.el.find(c))}):i.el.find(d).empty().hide()})},pageIndex:f,point:i,recordCount:e,pageSize:10,showDownload:!1},k=Pager.getInstance();k.init(j),$(d).show()},_query_zyysyzf:function(a){var b=this,c={orderStatus:a,startDate:$("#welcome-startDate").val(),endDate:$("#welcome-endDate").val()},d={signFlag:"0"};b.queryData3=new Model("PsnEshopQueryHistoryOrder",c),Common.LightBox.show(),Common.postRequest(b.queryData3.findPage(1,10,!0)).then(function(c){var e=CU.ajaxDataHandle(c);if(Common.LightBox.hide(),"00"==a&&e&&e.orderList){var f=[];$.each(e.orderList,function(a,b){"04"!=b.orderStatus&&(f[f.length]=b)})}e&&e.orderList&&e.orderList.length>0&&("04"==a?!0:f&&f.length)?($.each(e.orderList,function(a){e.orderList[a].orderDate=e.orderList[a].orderDate.replace(/-/g,"/")}),b.el.append("templates/welcome/serviceRecord.ejs",function(){$("#idServiceQueryResultData").html("").html("templates/welcome/serviceRecordData2.ejs",{list:e.orderList,params:d,orderSt:a},function(){b.bocPaging("templates/welcome/serviceRecordData2.ejs",b.queryData3,"#idServiceQueryResultData","#idServiceQueryResultPage",e.orderCount,1,d,a),CU.changeLan(b.el),Common.LightBox.show(),$("#serviceRecord-popup").show(),CU.setObjAbsCenter($("#serviceRecord-popup"));var c=$("#idServiceQueryResultData").find(".tb-con");c.children().height()>250&&c.css("overflowY","scroll")})})):Common.LightBox.showMessage(CU.getDictNameByKey("l6014"))})},_render:function(a,b){var c=this;args={company:"",currencyCode:"",fundType:"",riskGrade:"",fundInfo:a},Common.LightBox.show(),Common.postRequest(new Model("PsnGetFundDetail",{fundCode:a})).then(function(a){Common.LightBox.hide();var d=CU.ajaxDataHandle(a);if(c._cacheAttentionFundList=new Common.Hashtable,d){var e={fundInfo:d};Common.params={method:"fundBuy",fund:e,amount:b},Common.triggerAction("FundMarket")}})}});